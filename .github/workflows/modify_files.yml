name: Fetch URLs and update Loon directory

on:
  push:
    branches: [main]

jobs:
  fetch-urls-and-update-loon-directory:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Fetch URLs and update files
      run: |
        declare -a URLS=(
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Zhihu_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Weixin_Official_Accounts_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Weixin_external_links_unlock.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Weibo_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/UnionPay_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Remove_splash_screen_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/JD_Price.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Cainiao_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Bilibili_remove_ads.plugin"
          "https://gitlab.com/lodepuly/vpn_tool/-/raw/main/Tool/Loon/Plugin/Amap_remove_ads.plugin"
        )

        for url in "${URLS[@]}"
        do
          filename=$(basename "$url")
          echo "Fetching $url and saving to $filename"
          curl -s "$url" > "./Loon/$filename"
        done

    - name: Process files
      run: |
        # Read all file contents from Loon directory
        files=$(find ./Loon -type f)
        for file in $files
        do
          # Use regex to process the contents
          modified_contents=$(sed -e 's/reject-.*$/REJECT-TINYGIF/gI' -e 's/REJECT-.*$/REJECT-TINYGIF/gI' -e 's/hostname =/hostname = %APPEND%/g' -e 's/,\s?tag\s?=.*$//g' $file)
          # Save modified contents to Surge directory and change file extension
          surge_dir=./Surge
          surge_file=$(basename $file .plugin).sgmodule
          surge_path=$surge_dir/$surge_file
          mkdir -p $surge_dir
          echo "$modified_contents" > $surge_path
        done

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git add -A
        git commit -m "update and save files"
        git push
